openapi: 3.0.2
info:
  description: >-
    This API is meant for provisioning resources in a JWCC Provider Cloud Environment.
    The cloud products and services used in JWCC are provided by commercial cloud service providers (CSP).
    This API will be implemented and maintained by all participating CSPs.

    ## Organization of provisioned resources
    
    Provisioned resources under the purview of a mission owner are organized in a three-level hierarchy.
    *Portfolios* consist of one or more applications. *Applications* consist of one or more environments.
    *Environments* directly contain provisioned resources.

    * Portfolio
      * Application
        * Environment

    ## Access and security

    Although the implementation of these concepts will vary by vendor, adherence to the following principles is expected:
     - Each Portfolio, Application, and Environment will have isolated security controls
     - Access can be granted to *Operators* at each level
     - Administrative access to a Portfolio will provide inherited access to all contained Applications
     - Administrative access to an Application will provide inherited access to all contained Environments
     - Actual CSP resources and services (any IaaS or PaaS offerings from the CSP) will be provisioned only within an Environment

    Operators are specified generically as email/access level tuples. See [#/components/schemas/PortfolioOperatorRole](#/components/schemas/PortfolioOperatorRole) for an example.
    ATAT will request that individuals (uniquely identified by email address) be granted access to specific resources (Portfolios, Applications or Environments).
    It is expected that CSPs will manage account lifecycle and authorize Operators according to these requests.

    ### Access levels

    While the details of ATAT's generic access levels will differ by CSP, the following general guidelines apply:
    
    #### Portfolio Access Levels
     - `portfolio_administrator`: Root-level "break-glass" administrator account for all resources and operators under this Portfolio.
    
    #### Application and Environment Access Levels
     - `administrator`: Has full access to all assets under this Application/Environment.
     - `contributor`: Has access to create, update or remove resources under this Application/Environment. Cannot manage operator access.
     - `read_only`: Has access to view resources, configurations or logs under this Application/Environment, but cannot make any changes or create new resources.

    ## Funding sources

    Portfolios contain one or more *Funding Sources*. A funding source consists of a
    *Task Order* (TO) and a *Contract Line Item Number* (CLIN) on that TO. TOs contain one or more CLINs.
    CLINs specify funding amounts and a time period in which funds can be spent.

    ## Cost reporting

    Provisioned resources incur costs with participating CSPs. Costs related to provisioned resources can
    be attributed to specific CLINs. Actual and forecasted CSP costs can be reported by CLIN.
  version: 0.1.0
  title: ATAT CSP API
  contact:
    email: atat-dev+provisioning_api@ccpo.mil
tags:
  - name: access
    description: >-
      Operations to manage access to provisioned Portfolios
  - name: cost
    description: >-
      Operations to query for actual and forecasted costs
  - name: provisioning
    description: >-
      Operations to manage provisioned Portfolios
paths:
  '/portfolios':
    post:
      tags:
        - provisioning
      summary: Adds a new Portfolio
      description: Adds a new Portfolio to be provisioned, including Applications, Environments, and Operators. Once provisioned, Operators can log in to the CSP and begin using provisioned resources and services, funded by the provided Funding Source(s). See [#/info/description](#/info/description) and [#/components/schemas](#/components/schemas) for details of these constructs.
      operationId: addPortfolio
      requestBody:
        description: A new Portfolio
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Portfolio'
      responses:
        '200':
          description: Portfolio fully provisioned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PortfolioResponse'
        '202':
          description: Portfolio provisioning request has been accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProvisioningStatus'
          headers:
            Location:
              description: Endpoint which ATAT should poll to receive status updates for this provisioning job
              schema:
                type: string
                example: https://csp.com/jwcc/provisioning/123456789/status
        '405':
          description: Invalid input
  '/portfolios/{portfolioId}':
    get:
      tags:
        - provisioning
      summary: Gets an existing Portfolio
      description: Returns a single existing Portfolio, including Applications, Environments, and Operators
      operationId: getPortfolioById
      parameters:
        - name: portfolioId
          in: path
          description: ID of the Portfolio
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Portfolio successfully retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PortfolioResponse'
        '400':
          description: Invalid ID supplied
        '404':
          description: Portfolio not found
  '/portfolios/{portfolioId}/taskorders':
    post:
      tags:
        - cost
      summary: Adds a new funding source (TO)
      description: Adds a new funding source to an existng Portfolio
      operationId: addFundingSource
      parameters:
        - name: portfolioId
          in: path
          description: ID of the Portfolio
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PortfolioOperatorRole'
        '400':
          description: Invalid ID supplied
        '404':
          description: Portfolio not found
        '405':
          description: Invalid input
      requestBody:
        description: A Funding Source
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FundingSource'
  '/portfolios/{portfolioId}/operator-roles':
    post:
      tags:
        - access
      summary: Assigns a role to an Operator of the Portfolio
      description: Assigns a specific level of access to an Operator within a given Portfolio
      operationId: addPortfolioOperatorRole
      parameters:
        - name: portfolioId
          in: path
          description: ID of the Portfolio
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PortfolioOperatorRole'
        '405':
          description: Invalid input
      requestBody:
        description: A PortfolioOperatorRole that associates the Operator with a specific level of access
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PortfolioOperatorRole'
  '/portfolios/{portfolioId}/applications/{applicationId}/operator-roles':
    post:
      tags:
        - access
      summary: Assigns a role to an Operator of the Application
      description: Assigns a specific level of access to an Operator within a given Application
      operationId: addApplicationOperatorRole
      parameters:
        - name: portfolioId
          in: path
          description: ID of the Portfolio
          required: true
          schema:
            type: string
        - name: applicationId
          in: path
          description: ID of the Application
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApplicationOperatorRole'
        '405':
          description: Invalid input
      requestBody:
        description: An ApplicationOperatorRole that associates the Operator with a specific level of access
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ApplicationOperatorRole'
  '/portfolios/{portfolioId}/applications/{applicationId}/environments/{environmentId}/operator-roles':
    post:
      tags:
        - access
      summary: Assigns a role to an Operator of the Environment
      description: Assigns a specific level of access to an Operator within a given Environment
      operationId: addEnvironmentOperatorRole
      parameters:
        - name: portfolioId
          in: path
          description: ID of the Portfolio
          required: true
          schema:
            type: string
        - name: applicationId
          in: path
          description: ID of the Application
          required: true
          schema:
            type: string
        - name: environmentId
          in: path
          description: ID of the Environment
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnvironmentOperatorRole'
        '405':
          description: Invalid input
      requestBody:
        description: An EnvironmentOperatorRole that associates the Operator with a specific level of access
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EnvironmentOperatorRole'
  '/portfolios/{portfolioId}/taskorders/{taskOrderNumber}/clins/{clin}/cost':
    post:
      tags:
        - cost
      summary: Returns cost data by Clin
      description: Queries CSP for actual or forecasted cost data by Clin
      operationId: getCostsByClin
      parameters:
        - name: portfolioId
          in: path
          description: ID of the Portfolio
          required: true
          schema:
            type: string
        - name: taskOrderNumber
          in: path
          description: task order number
          required: true
          schema:
            type: string
        - name: clin
          in: path
          description: contract line item number
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CostRequest'
            examples:
              CostRequestActual:
                $ref: '#/components/examples/CostRequestActual'
      responses:
        '200':
          description: Cost operation successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CostResponse'
              examples:
                CostResponseActual:
                  $ref: '#/components/examples/CostResponseActual'
        '400':
          description: Invalid ID supplied
        '404':
          description: Portfolio not found
  '/portfolios/{portfolioId}/applications':
    post:
      tags:
        - provisioning
      summary: Adds new Applications
      description: Adds new Applications to be provisioned in an existing Portfolio
      operationId: addApplications
      parameters:
        - name: portfolioId
          in: path
          description: ID of the Portfolio
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: '#/components/schemas/Application'
      responses:
        '200':
          description: Application(s) fully provisioned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApplicationsResponse'
        '400':
          description: Invalid ID supplied
        '404':
          description: Portfolio not found
  '/portfolios/{portfolioId}/applications/{applicationId}/environments':
    post:
      tags:
        - provisioning
      summary: Adds new Environments
      description: Adds new Environments to be provisioned in an existing Application
      operationId: addEnvironments
      parameters:
        - name: portfolioId
          in: path
          description: ID of the Portfolio
          required: true
          schema:
            type: string
        - name: applicationId
          in: path
          description: ID of the Application
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: '#/components/schemas/Environment'
      responses:
        '200':
          description: Cost operation successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnvironmentsResponse'
        '400':
          description: Invalid ID supplied
        '404':
          description: Portfolio not found
components:
  schemas:
    ProvisioningStatus:
      type: object
      description: >-
        Represents the status of a provisioning job submitted via POST /portfolios
      properties:
        id:
          type: string
          description: The ID of the Provisioning job; used for retrieving status to inform end user
          example: 123456789
        status:
          type: string
          enum:
            - "NOT_STARTED"
            - "IN_PROGRESS"
            - "COMPLETE"
            - "FAILED"
    Portfolio:
      type: object
      description: >-
        Logical container for a set of cloud resources which are paid for by the same set of Funding Sources.
        Contains a set of Applications, each of which contain a set of Environments in turn, all of which should support
        independent management and access control.
      required:
        - name
      properties:
        name:
          type: string
          example: "Sample Portfolio name"
        funding_sources:
          type: array
          items:
            allOf:
              - $ref: '#/components/schemas/FundingSource'
        applications:
          type: array
          items:
            allOf:
              - $ref: '#/components/schemas/Application'
        operator_roles:
          type: array
          items:
            allOf:
              - $ref: '#/components/schemas/PortfolioOperatorRole'
    PortfolioResponse:
      allOf:
        - $ref: '#/components/schemas/Portfolio'
        - type: object
          properties:
            id:
              type: string
              example: "csp-portfolio-id-123"
            applications:
              type: array
              items:
                allOf:
                  - $ref: '#/components/schemas/ApplicationResponse'
    FundingSource:
      type: object
      description: >-
        A Task Order and CLIN used to pay for provisioned resources and services
      properties:
        task_order_number:
          type: string
          example: "1234567891234"
        clin:
          type: string
          example: "0001"
        pop_start_date:
          type: string
          format: date
          example: "2021-07-01"
        pop_end_date:
          type: string
          format: date
          example: "2022-07-01"
    Application:
      type: object
      description: >-
        Applications represent a set of Environments which make up a single
        application, system or set of related services as defined by a Mission
        Owner
      properties:
        name:
          type: string
          example: "Sample Application name"
        description:
          type: string
          example: "Sample Application description"
        environments:
          type: array
          items:
            allOf:
              - $ref: '#/components/schemas/Environment'
        operator_roles:
          type: array
          items:
            allOf:
              - $ref: '#/components/schemas/ApplicationOperatorRole'
    ApplicationsResponse:
      allOf:
        - type: object
          properties:
            portfolioId:
              type: string
              example: "csp-portfolio-id-123"
            applications:
              type: array
              items:
                allOf:
                  - $ref: '#/components/schemas/ApplicationResponse'
    ApplicationResponse:
      allOf:
        - type: object
          properties:
            id:
              type: string
              example: "csp-application-id-123"
            environments:
              type: array
              items:
                allOf:
                  - $ref: '#/components/schemas/EnvironmentResponse'
        - $ref: '#/components/schemas/Application'
    Environment:
      type: object
      description: >-
        Environments represent a grouping of cloud resources, organized by
        system usage (e.g. Production, Staging, Test, Dev, etc.)
      required:
        - name
      properties:
        name:
          type: string
          example: "Production"
        operator_roles:
          type: array
          items:
            allOf:
              - $ref: '#/components/schemas/EnvironmentOperatorRole'
    EnvironmentsResponse:
      allOf:
        - type: object
          properties:
            portfolioId:
              type: string
              example: "csp-portfolio-id-123"
            applicationId:
              type: string
              example: "csp-application-id-123"
            environments:
              type: array
              items:
                allOf:
                  - $ref: '#/components/schemas/EnvironmentResponse'
    EnvironmentResponse:
      allOf:
        - $ref: '#/components/schemas/Environment'
        - type: object
          properties:
            id:
              type: string
              example: "csp-environment-id-123"
    PortfolioOperatorRole:
      type: object
      required:
        - operator_email
        - access
      properties:
        operator_email:
          type: string
          example: "portfolio.admin@mail.mil"
        access:
          $ref: '#/components/schemas/PortfolioAccess'
    ApplicationOperatorRole:
      type: object
      required:
        - operator_email
        - access
      properties:
        operator_email:
          type: string
          example: "application.user@mail.mil"
        access:
          $ref: '#/components/schemas/ApplicationAccess'
    EnvironmentOperatorRole:
      type: object
      required:
        - operator_email
        - access
      properties:
        operator_email:
          type: string
          example: "environment.user@mail.mil"
        access:
          $ref: '#/components/schemas/EnvironmentAccess'
    PortfolioAccess:
      description: Operator access level to Portfolio
      type: string
      enum:
        - portfolio_administrator
    ApplicationAccess:
      description: Operator access level to Application
      type: string
      enum:
        - administrator
        - contributor
        - read_only
    EnvironmentAccess:
      description: Operator access level to Environment
      type: string
      enum:
        - administrator
        - contributor
        - read_only
    TimePeriod:
      type: object
      properties:
        start_date:
          type: string
          format: date
          example: "2021-10-01"
        end_date:
          type: string
          format: date
          example: "2021-12-01"
    CostRequest:
      type: object
      properties:
        period:
          $ref: '#/components/schemas/TimePeriod'
        granularity:
          type: string
          enum:
            - "MONTHLY"
            - "DAILY"
        type:
          type: string
          enum:
            - "ACTUAL"
            - "FORECAST"
    CostResponse:
      type: object
      properties:
        total:
          type: string
          description: Total cost (ACTUAL or FORECAST) for entire time period in USD
          example: "12345.67"
        results:
          type: array
          items:
            properties:
              period:
                $ref: '#/components/schemas/TimePeriod'
              value:
                type: string
                description: Cost (ACTUAL or FORECAST) for the given time period in USD
  examples:
    CostRequestActual:
      value:
        period:
          start_date: "2021-10-01"
          end_date: "2021-12-01"
        granularity: "MONTHLY"
        type: "ACTUAL"
    CostResponseActual:
      value:
        total: "50.00"
        results:
          - period:
              start_date: "2021-10-01"
              end_date: "2021-11-01"
            value: "20.00"
          - period:
              start_date: "2021-11-01"
              end_date: "2021-12-01"
            value: "30.00"
